generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Agent {
  id           String    @id @default(cuid())
  name         String
  description  String?
  walletPubkey String    @unique
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt @default(now())
  comments     Comment[]

  // Identity
  strategy     String    @default("general")   // conservative, growth, alignment, yield, general

  // Governance Scope (JSON arrays stored as strings for SQLite)
  allowedDaos         String?  // JSON: ["realmPk1", "realmPk2"] — null = all
  allowedMints        String?  // JSON: ["mintPk1"] — restrict to specific governance tokens
  maxVotingPowerPct   Int      @default(100)    // 0–100, caps % of available voting power used per DAO

  // Voting Behavior
  autoVoteEnabled     Boolean  @default(false)
  voteThreshold       String   @default("simple_majority")  // simple_majority, supermajority, unanimous
  abstainOnLowInfo    Boolean  @default(true)
  proposalFilter      String   @default("all")              // all, treasury_only, parameter_only, defi_only

  // Risk Controls
  executionEnabled    Boolean  @default(false)  // can this agent execute proposals on-chain?
  requireApproval     Boolean  @default(true)   // require manual approval before execution
  paused              Boolean  @default(false)   // instant kill switch
  pausedAt            DateTime?
  pausedReason        String?
}

model RealmCache {
  id                String   @id
  name              String
  authority         String
  communityMint     String
  councilMint       String?
  governancePubkey  String?
  programVersion    Int      @default(3)
  onChain           Boolean  @default(false)
  authoritySecret   String?  // base58 secret key of the mint authority (for minting governance tokens on join)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ProposalCache {
  id                  String    @id
  realmId             String
  name                String
  description         String
  state               String
  createdBy           String
  governancePubkey    String?
  tokenOwnerRecordPk  String?
  onChain             Boolean   @default(false)
  proposalType        String    @default("governance")
  executionParams     String?
  executionStatus     String?
  executionTxSignature String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  comments            Comment[]
  votes               Vote[]
  executionLogs       ExecutionLog[]
}

model Comment {
  id         String        @id @default(cuid())
  proposalId String
  proposal   ProposalCache @relation(fields: [proposalId], references: [id])
  agentId    String
  agent      Agent         @relation(fields: [agentId], references: [id])
  content    String
  createdAt  DateTime      @default(now())
}

model Vote {
  id           String        @id @default(cuid())
  proposalId   String
  proposal     ProposalCache @relation(fields: [proposalId], references: [id])
  voterPubkey  String
  vote         String
  txSignature  String?
  onChain      Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([proposalId, voterPubkey])
}

model RealmMember {
  id        String   @id @default(cuid())
  realmId   String
  agentId   String
  pubkey    String
  joinedAt  DateTime @default(now())

  @@unique([realmId, pubkey])
}

model AuthChallenge {
  id        String   @id @default(cuid())
  nonce     String   @unique
  pubkey    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model TreasuryConfig {
  id            String   @id @default(cuid())
  realmId       String   @unique
  walletPubkey  String
  encryptedKey  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model WalletRoleRecord {
  id            String   @id @default(cuid())
  type          String   // agent | treasury
  publicKey     String   @unique
  authorityType String   @default("ai_runtime") // ai_runtime | governance_pda | multisig
  ownerId       String?  // agentId or realmId depending on type
  createdAt     DateTime @default(now())
}

model ExecutionLog {
  id            String        @id @default(cuid())
  proposalId    String
  proposal      ProposalCache @relation(fields: [proposalId], references: [id])
  type          String
  status        String
  txSignature   String?
  inputParams   String
  outputData    String?
  error         String?
  executedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ProtocolEvent {
  id        String   @id @default(cuid())
  type      String
  message   String
  metadata  String?
  createdAt DateTime @default(now())
}

model OmniPairExecution {
  id              String    @id @default(cuid())
  daoPk           String
  proposalPk      String
  executionType   String    // borrow | lend | repay | refinance
  assetMint       String
  collateralMint  String?
  amount          String
  status          String    @default("pending") // pending | executed | failed
  txSignature     String?
  errorMessage    String?
  treasuryPk      String?   // treasury wallet that signed this execution
  executedBy      String    @default("governance") // governance | manual
  createdAt       DateTime  @default(now())
  executedAt      DateTime?
}
